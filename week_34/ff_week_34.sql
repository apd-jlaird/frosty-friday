------------------------------------------------------------
-- Frosty Friday Week 34
-- https://frostyfriday.org/2023/02/17/week-34-data-structuring/
------------------------------------------------------------
use role jamielaird;
use database jamielaird;
use schema frosty_friday;

------------------------------------------------------------
-- Startup Code
------------------------------------------------------------
create or replace table start_data(
    code VARCHAR
  , code_parent VARCHAR
  , valid_until DATE
  , valid_from DATE
  , is_lowest_level BOOLEAN
  , max_level INTEGER
)
as
select * from values
    ('CC0193','EBGABA','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',1,7)
  , ('CC0194','EBGABA','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',1,7)
  , ('EBGABA','EBGAB','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('EBGAB','EBGA','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('EBGA','EBG','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('EBG','EB','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('EB','ZZ','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('ZZ',NULL,'9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,7)
  , ('7050307','CC','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',1,3)
  , ('CC','A1','9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,3)
  , ('A1',NULL,'9999-01-01 00:00:00.000','1950-01-01 00:00:00.000',0,3)
;

------------------------------------------------------------
-- Solution
------------------------------------------------------------
with recursive parents (code) as (

select code
from start_data
where code_parent is null

union all

select

from parents joi

)
select * from cte;

------------------------------------------------------------
-- Cleanup
------------------------------------------------------------
drop table if exists jamielaird.frosty_friday.start_data;

------------------------------------------------------------
-- Resources
------------------------------------------------------------
-- https://docs.snowflake.com/en/user-guide/queries-hierarchical